# GitHub Actions Workflow: ë°±ì—”ë“œ ì •ì  ë¶„ì„ ë° íƒ€ì… ê²€ì‚¬
# ëª©ì : feature â†’ develop ë¸Œëœì¹˜ë¡œ PR ìƒì„± ë˜ëŠ” ë³‘í•© ì‹œ ìë™ ê²€ì‚¬ ìˆ˜í–‰

name: Backend Static Analysis & Type Check

on:
  push:
    branches: [ develop ]
  pull_request:
    # ëŒ€ìƒ ë¸Œëœì¹˜ê°€ developì¼ ë•Œë§Œ ì‹¤í–‰
    branches: [develop]
    # backend í´ë” ë‚´ë¶€ ì½”ë“œê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    paths:
      - 'backend/**'

jobs:
  check-backend:
    # GitHub Actionsê°€ ì œê³µí•˜ëŠ” ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    name: Run Checkstyle and Compile

    steps:
      # 1. PRì˜ ì½”ë“œ ë°›ì•„ì˜¤ê¸° (GitHubì—ì„œ checkout)
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Java 21 ì„¤ì¹˜ (Temurinì€ OpenJDKì˜ ê³µì‹ ë°°í¬íŒ ì¤‘ í•˜ë‚˜)
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'         # Java 21ë¡œ ì„¤ì •
          distribution: 'temurin'    # ë¬´ë£Œ OpenJDK ë°°í¬íŒ

      # 3. Checkstyle ì‹¤í–‰ (ì •ì  ë¶„ì„ ìˆ˜í–‰)
      - name: Run Checkstyle
        working-directory: ./backend # backend í´ë” ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰
        run: ./gradlew checkstyleMain

      # 4. Java ì»´íŒŒì¼ë§Œ ìˆ˜í–‰ (íƒ€ì… ì—ëŸ¬ í™•ì¸ìš©)
      - name: Type Check (Compile Only)
        working-directory: ./backend
        run: ./gradlew compileJava
          
      # 5. ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ ì „ì†¡ , ì—ëŸ¬ ë©”ì„¸ì§€ ì „ì†¡
      - name: Notify Discord on Checkstyle failure
        if: failure()
        run: |
          echo "ğŸš¨ Checkstyle ì‹¤íŒ¨: ìœ„ë°˜ ë‚´ì—­ì„ Discordì— ì „ì†¡í•©ë‹ˆë‹¤."
          
          # Checkstyle ì˜¤ë¥˜ ì¶”ì¶œ: ë©”ì‹œì§€, ì¤„ë²ˆí˜¸ ì¶”ì¶œ
          ERRORS=$(grep '<error ' backend/build/reports/checkstyle/*.xml | \
            sed -n 's/.*line="\([0-9]\+\)".*message="\([^"]\+\)".*/âŒ \2 (Line \1)/p' | \
            head -n 3)
          
          # ì¤„ë°”ê¿ˆ ì²˜ë¦¬
          ERROR_MSG=$(echo "$ERRORS" | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # Discord ì „ì†¡
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"ğŸš¨ Checkstyle ì˜¤ë¥˜ ë°œìƒ (ìµœëŒ€ 3ê±´):\\n$ERROR_MSG\\nğŸ‘‰ ìì„¸í•œ ë‚´ìš©ì€ GitHub Actions ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
     
      
 
