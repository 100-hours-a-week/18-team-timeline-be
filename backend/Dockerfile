FROM eclipse-temurin:21-jdk

# μ‘μ—… λ””λ ‰ν† λ¦¬ μ„¤μ •
WORKDIR /app

# μ „μ²΄ ν”„λ΅μ νΈ λ³µμ‚¬
COPY . .

# OTEL Agent JAR λ³µμ‚¬
COPY opentelemetry-javaagent.jar /app/opentelemetry-javaagent.jar

# GitHub Actionsμ—μ„ μ „λ‹¬λ°›μ„ ARG μ •μ
ARG DB_URL
ARG DB_USERNAME
ARG DB_PASSWORD
ARG KAKAO_CLIENT_ID
ARG KAKAO_REDIRECT_URI
ARG JWT_SECRET_CODE
ARG FE_BASE_URL
ARG BE_BASE_URL
ARG AI_BASE_URL
ARG EC2_PUBLIC_URL_1
ARG EC2_PUBLIC_URL_2
ARG EC2_PUBLIC_URL_3
ARG OTEL_EXPORTER_OTLP_ENDPOINT  # π”¥ OTEL μ—”λ“ν¬μΈνΈλ„ ARGλ΅ μ „λ‹¬

# ν™κ²½ λ³€μ μ„¤μ •
ENV DB_URL=$DB_URL \
    DB_USERNAME=$DB_USERNAME \
    DB_PASSWORD=$DB_PASSWORD \
    KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID \
    KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI \
    JWT_SECRET_CODE=$JWT_SECRET_CODE \
    FE_BASE_URL=$FE_BASE_URL \
    BE_BASE_URL=$BE_BASE_URL \
    AI_BASE_URL=$AI_BASE_URL \
    EC2_PUBLIC_URL_1=$EC2_PUBLIC_URL_1 \
    EC2_PUBLIC_URL_2=$EC2_PUBLIC_URL_2 \
    EC2_PUBLIC_URL_3=$EC2_PUBLIC_URL_3 \
    OTEL_EXPORTER_OTLP_ENDPOINT=$OTEL_EXPORTER_OTLP_ENDPOINT

# Gradle λΉλ“ (ν…μ¤νΈ μƒλµ)
RUN ./gradlew build -x test -x compileTestJava -x processTestResources

# OTEL Agentμ™€ ν•¨κ» Spring Boot μ‹¤ν–‰
CMD java \
  -javaagent:/app/opentelemetry-javaagent.jar \
  -Dotel.service.name=backend-service \
  -Dotel.exporter.otlp.endpoint=$OTEL_EXPORTER_OTLP_ENDPOINT \
  -Dotel.metrics.exporter=none \
  -Dspring.datasource.url="$DB_URL" \
  -Dspring.datasource.username="$DB_USERNAME" \
  -Dspring.datasource.password="$DB_PASSWORD" \
  -Dspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver \
  -jar build/libs/backend-0.0.1-SNAPSHOT.jar

